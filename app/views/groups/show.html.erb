<h2><%= @group.name %> Page</h2>
<h4>Members:</h4>
  <p><%= @members.join(", ") %></p>
<% i=0 %>
<% for user in @group.users %>
  <h3>Member <%= i+1 %>: <%= user.first_name %> <%= user.last_name %></h3>
  <% if user.metrics.length > 0 %>
    <p>Week of <%= Date.today.beginning_of_week(:sunday) %></p>
    <%= column_chart @group_week_data[i], colors: ["#4caf50", "#999"]  %>
    <p>Recent Weeks</p>
    <table class="metric-table">
      <tr>
        <th>Metric</th>
        <th>Weekly Goal</th>
        <th>Start Date</th>
        <% for date in @group_dates[i] %>
          <th><%= date.strftime("%m/%d") %></th>
        <% end %>
      </tr>
    <% for metric in user.metrics %>
      <tr>
        <td><%= metric.name %></td>
        <td><%= metric.target %> <%= metric.unit %></td>
        <td><%= metric.start_date %></td>
        <% ordered_weeks = metric.weeks.order("date")%>
        <% if (@group_dates[i][0] - ordered_weeks[0]["date"].beginning_of_week(:sunday)).to_i >= 0 %>
          <% week_index = 0 %>
          <% for week in ordered_weeks%>
            <% if week.date - @group_dates[i][0] == 0 %>
              <% break %>
            <% else %>
              <% week_index += 1 %>
            <% end %>
          <% end %>
          <% week_count = 0 %>
          <% until week_count >= (@group_dates[i].length+week_index) do %>
            <% if week_count >= week_index %>
              <% if metric.good %>
                <td class=<%= ordered_weeks[week_count]["total"] >= metric.target ? "metric-table__hit" : "metric-table__missed" %>><%= ordered_weeks[week_count]["total"] %></td>
              <% else %>
                <td class=<%= ordered_weeks[week_count]["total"] <= metric.target ? "metric-table__hit" : "metric-table__missed" %>><%= ordered_weeks[week_count]["total"] %></td>
              <% end %>
            <% end %>
            <% week_count +=1 %>
          <% end %>
        <% else %>
          <% week_count = 0 %>
          <% date_count = 0 %>
          <% until date_count >= (@group_dates[i].length) do %>
            <% if (ordered_weeks[week_count]["date"] - @group_dates[i][date_count]).to_i <= 0 %>
                <% if metric.good %>
                  <td class=<%= ordered_weeks[week_count]["total"] >= metric.target ? "metric-table__hit" : "metric-table__missed" %>><%= ordered_weeks[week_count]["total"] %></td>
                <% else %>
                  <td class=<%= ordered_weeks[week_count]["total"] <= metric.target ? "metric-table__hit" : "metric-table__missed" %>><%= ordered_weeks[week_count]["total"] %></td>
                <% end %>
                <% week_count += 1 %>
            <% else %>
              <td class="metric-table__prior"></td>
            <% end %>
            <% date_count += 1 %>
          <% end %>
        <% end  %>
      </tr>
    <% end %>
    </table>









    <!-- <table class="metric-table">
      <tr>
        <th>Metric</th>
        <th>Weekly Goal</th>
        <th>Start Date</th>
        <% for date in @group_dates[i] %>
          <th><%= date.strftime("%m/%d") %></th>
        <% end %>
      </tr>
    <% j = 0 %>
    <% for metric in user.metrics %>
      <tr>
        <td><%= metric.name %></td>
        <td><%= metric.target %> <%= metric.unit %></td>
        <td><%= metric.start_date %></td>
        <% week = 0 %>
        <% for weekly_count in @group_rows[i][j] %>
          <% if (@group_dates[i][week]+6)<metric.start_date %>
            <td class="metric-table__prior"><%= weekly_count %></td>
          <% elsif metric.good %>
            <td class=<%= weekly_count >= metric.target ? "metric-table__hit" : "metric-table__missed" %>><%= weekly_count %></td>
          <% else %>
            <td class=<%= weekly_count <= metric.target ? "metric-table__hit" : "metric-table__missed" %>><%= weekly_count %></td>
          <% end %>
          <% week += 1 %>
        <% end %>
      </tr>
      <% j+=1 %>
    <% end %>
    </table> -->
    <br>
  <% else %>
    <p><%= user.first_name %> has no metrics, yet</p>
  <% end %>
  <% i+=1 %>
<% end %>
<br>
<div class="links">
  <%= link_to "Invite new members", new_user_group_invitation_path(current_user, @group) %>
  <%= link_to "Leave group", leave_group_path(current_user, @group), method: :delete, data: {confirm: "Are you sure you want to leave this group?"} %>
  <% if @membership.admin %>
    <%= link_to "Edit group", edit_user_group_path(current_user, @group)%>
  <% end %>
  <% if @membership.admin %>
    <%= link_to "Delete group", "/users/#{current_user.id}/groups/#{@group.id}", method: :delete, data: {confirm: "Are you sure you want to delete this group?"} %>
  <% end %>
  <% if @group.competitions.length > 0 %>
<h2>Competitions:</h2>
  <% for competition in @group.competitions %>
    <h4><%= link_to competition.metric_name, user_group_competition_path(current_user, @group, competition) %></h4>
  <% end %>
<% end %>
  <%= link_to "Create new competition", new_user_group_competition_path(current_user, @group)%>
</div>
